<!doctype html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Charles Troupin</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Turning ocean data into stories">
    <meta name="keywords" content="data analyst, engineering, oceanography, ocean science, numerical modelling" />
    <meta name="author" content="Troupin Charles">
    <link rel="canonical" href="https://ctroupin.github.io/posts/2021-03-21-cartopy-issues/">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

    <!-- Custom CSS & Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link rel="stylesheet" href="/style.css">

    <!-- Google verification -->
    

    <!-- Bing Verification -->
    

    <!-- Custom Fonts
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fontawesome-all.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fa-brands.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fa-regular.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/brands.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/fontawesome.min.css">
    <link rel="stylesheet" href="/assets/css/academicons.css">
    <link href="//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>


<html lang="en-US">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<title>Charles Troupin by </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=">

	<meta name="viewport" content="width=device-width">
	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

</head>

<body>

	<div class="container">
		<div class="col-lg-8 col-lg-offset-2">
			<center>
				<h2> Solving issues with Cartopy </h2>
			</center>
			<blogsection>
				 <div style="text-align:left; vertical-align: middle; ">
					
						<h4><i class="far fa-calendar-alt"></i></h4> 29 July 2021 &nbsp;
					
					
						<h4><i class="fas fa-wrench"></i></h4> Python, matplotlib, Cartopy &nbsp;
					
					
						<h4><i class="fas fa-tags"></i></h4> Plots &nbsp;
					
					
				</div>
				<p>Not to long ago I <a href="/posts/2021-04-17-cartopy-wms/">posted</a> about <code class="highlighter-rouge">Cartopy</code> and how it was easy to install it. Well, I must say it is not as easy as running
<code class="highlighter-rouge">pip install cartopy</code>. While the installation could go without a warning message,
the execution of some code could quickly lead to problems.</p>

<h2 id="the-issue">The issue</h2>

<p>Here is an example of code that created the problem (let’s save it a file
<code class="highlighter-rouge">test_carto.py</code> to be used later):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="n">ccrs</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>which lead to the error message:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">Geometry</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="n">Point</span> <span class="ow">or</span> <span class="n">LineString</span>
<span class="n">python</span><span class="p">:</span> <span class="n">geos_ts_c</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">3991</span><span class="p">:</span> <span class="nb">int</span> <span class="n">GEOSCoordSeq_getSize_r</span><span class="p">(</span><span class="n">GEOSContextHandle_t</span><span class="p">,</span> <span class="n">const</span> <span class="n">geos</span><span class="p">::</span><span class="n">geom</span><span class="p">::</span><span class="n">CoordinateSequence</span><span class="o">*</span><span class="p">,</span> <span class="n">unsigned</span> <span class="nb">int</span><span class="o">*</span><span class="p">):</span> <span class="n">Assertion</span> <span class="err">`</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">cs</span><span class="s">' failed.</span><span class="err">
</span><span class="s">Aborted (core dumped)</span><span class="err">
</span></code></pre></div></div>

<h2 id="toward-the-solution">Toward the solution</h2>

<h3 id="your-friend-stackoverflow">Your friend: StackOverFlow</h3>

<p>The first thing I found on a research was from StackOverFlow:</p>
<blockquote>
  <p>The problem is a wrong version of shapely, with Cartopy the binary package shouldn’t be used, it should be built from source instead.</p>
</blockquote>

<p>But is it really a wrong version? (by the way, what is a wrong version?)?   <br />
Let’s check with <code class="highlighter-rouge">pip show shapely</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>Name: Shapely
Version: 1.7.1
Summary: Geometric objects, predicates, and operations
Home-page: https://github.com/Toblerity/Shapely
Author: Sean Gillies
Author-email: sean.gillies@gmail.com
License: BSD
Location: /home/ctroupin/Software/PythonEnvs/OpenDriftCanary/lib/python3.8/site-packages
Requires:
Required-by: Cartopy
</code></pre></div></div>
<p>1.7.1 was released in August 2020, maybe I should try a more recent version: 1.8a1,
released in March 2021. I tried</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>pip uninstall shapely
pip <span class="nb">install </span>shapely <span class="nt">--no-binary</span> shapely
</code></pre></div></div>
<p>then re-run the <code class="highlighter-rouge">cartopy</code> installation. Still failing.</p>

<h3 id="reading-the-doc">Reading the doc</h3>

<p>According to <a href="https://pypi.org/project/Shapely/"><code class="highlighter-rouge">shapely</code></a> documentation,
one should run this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="nv">GEOS_CONFIG</span><span class="o">=</span>/path/to/geos-config pip <span class="nb">install </span>shapely
</code></pre></div></div>
<p>where <code class="highlighter-rouge">GEOS_CONFIG</code> environment variable has to be set according to the
<a href="https://github.com/libgeos/geos"><code class="highlighter-rouge">GEOS</code></a> library you are using. I did a quick
search with <code class="highlighter-rouge">find</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>find / <span class="nt">-name</span> <span class="s1">'geos-config'</span> <span class="nt">-type</span> f
</code></pre></div></div>
<p>and it turned out I had 20 locations containing <code class="highlighter-rouge">geos-config</code>… Not sure which one to
use.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>/bin/geos-config
/usr/bin/geos-config
/usr/local/lib/bin/geos-config
/usr/local/bin/geos-config
...
</code></pre></div></div>
<p>So I tried with the latest version I had previously installed, 3.9.1, but again,
that did not solve the initial problem. Then I tried with version 3.6.1:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="nv">GEOS_CONFIG</span><span class="o">=</span>/home/ctroupin/Software/geos-3.6.1/tools/geos-config pip <span class="nb">install </span>shapely
</code></pre></div></div>
<p>Still failing when running the example.</p>

<h3 id="building-cartopy-from-source">Building <code class="highlighter-rouge">cartopy</code> from source</h3>

<p>According to <a href="https://github.com/SciTools/cartopy">cartopy doc</a>, we can do:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>git clone https://github.com/SciTools/cartopy.git
<span class="nb">cd </span>cartopy
python setup.py <span class="nb">install</span>
</code></pre></div></div>
<p>which should work if all the prerequisites were installed. Here there is also
a subtlety: if the installation of done using the <em>master</em> branch from the GitHub
repository, the last line issued on the screen is:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>Finished processing dependencies <span class="k">for </span><span class="nv">Cartopy</span><span class="o">==</span>0.0.0
</code></pre></div></div>
<p>i.e., the version doesn’t seem correct. Then in a Python session, the command</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="kn">import</span> <span class="nn">cartopy</span>
</code></pre></div></div>
<p>yields this error:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s">"/home/ctroupin/Software/PythonEnvs/ToDelete/lib/python3.8/site-packages/Cartopy-0.0.0-py3.8-linux-x86_64.egg/cartopy/__init__.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">7</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="kn">from</span> <span class="nn">._version</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">__version__</span>  <span class="c"># noqa: F401</span>
<span class="nb">ImportError</span><span class="p">:</span> <span class="n">cannot</span> <span class="kn">import</span> <span class="nn">name</span> <span class="s">'version'</span> <span class="k">from</span> <span class="s">'cartopy._version'</span> <span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ctroupin</span><span class="o">/</span><span class="n">Software</span><span class="o">/</span><span class="n">PythonEnvs</span><span class="o">/</span><span class="n">ToDelete</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">Cartopy</span><span class="o">-</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">.</span><span class="mi">8</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">egg</span><span class="o">/</span><span class="n">cartopy</span><span class="o">/</span><span class="n">_version</span><span class="o">.</span><span class="n">py</span><span class="p">)</span>
</code></pre></div></div>
<p>which seems to be related to the version number.</p>

<p><strong>Solution:</strong></p>
<ol>
  <li>a dirty way to solve that is to comment the line 7 of <code class="highlighter-rouge">__init__.py</code>.
That works…</li>
  <li>Otherwise, switch to another branch and re-run the installation:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>git checkout v0.18.0
python setup.py <span class="nb">install</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="missing-geos-library">Missing GEOS library</h3>

<p>Running again the example from the beginning leads to this error:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="nb">OSError</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">username</span><span class="o">/</span><span class="n">PythonEnvironments</span><span class="o">/</span><span class="n">GPXproc</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgeos_c</span><span class="o">.</span><span class="n">so</span><span class="p">:</span> <span class="n">cannot</span> <span class="nb">open</span> <span class="n">shared</span> <span class="nb">object</span> <span class="nb">file</span><span class="p">:</span> <span class="n">No</span> <span class="n">such</span> <span class="nb">file</span> <span class="ow">or</span> <span class="n">directory</span>
</code></pre></div></div>
<p>which I solved in a not very clever way: by creating a soft link to the existing library <code class="highlighter-rouge">libgeos_c.so</code> in the <code class="highlighter-rouge">lib</code> directory of my virtual environment.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="nb">cd</span> /home/username/PythonEnvironments/GPXproc/lib/
<span class="nb">ln</span> <span class="nt">-sfv</span> /usr/local/lib/lib/libgeos_c.so <span class="nb">.</span>
</code></pre></div></div>

<h2 id="summary">Summary</h2>

<p><img src="https://ctroupin.github.io/figures/blog/cartopy-wms/cartopytest01.jpg" class="img-responsive" /></p>

<p>Here is the list of commands that lead to a working environment. For sure they
are things that can be improved, for example the step in which the <code class="highlighter-rouge">libgeos_c</code> file is linked in the lib directory of the virtual environment.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="nv">venvname</span><span class="o">=</span><span class="s2">"ToDelete"</span>
mkvirtualenv <span class="nt">--python</span><span class="o">=</span>/usr/local/bin/python3.8 <span class="k">${</span><span class="nv">venvname</span><span class="k">}</span>
pip <span class="nb">install </span>matplotlib
pip <span class="nb">install </span>scipy
pip <span class="nb">install </span>cython
pip uninstall shapely
pip <span class="nb">install </span>shapely <span class="nt">--no-binary</span> shapely
<span class="nv">GEOS_CONFIG</span><span class="o">=</span>/home/ctroupin/Software/geos-3.6.1/tools/geos-config pip <span class="nb">install </span>shapely
<span class="nb">ln</span> <span class="nt">-sv</span> /usr/local/lib/lib/libgeos_c.so <span class="k">${</span><span class="nv">WORKON_HOME</span><span class="k">}</span>/<span class="k">${</span><span class="nv">venvname</span><span class="k">}</span>/lib/libgeos_c.so
git clone git@github.com:SciTools/cartopy.git
<span class="nb">cd </span>cartopy
git checkout v0.18.0
python setup.py <span class="nb">install
cd</span> ..
python test_carto.py
</code></pre></div></div>

<h2 id="edit-march-28">Edit [March 28]</h2>

<p>One year later the installation story is not yet completed for me. I re-ran
the procedure above, just trying to use a more recent release of <code class="highlighter-rouge">Cartopy</code> (0.20),
but the command <code class="highlighter-rouge">python setup.py install</code> gave me an error:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>GEOS version 3.3.3 is installed, but cartopy requires at least version 3.7.2.
</code></pre></div></div>
<p>even if I was using 3.6.1… so I don’t know. Sticking to 0.18 works so I won’t
dig deeper right now.</p>

			</blogsection>
		</div>
	</div>
</body>

</body>
</html>
