	<!DOCTYPE html>
	<html>
		<head>
			<meta charset="UTF-8"/>

			<meta name="viewport" content="width=device-width, initial-scale=1" />
			<title>
				Contacts for internships abroad
			</title>
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css"/>
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.4.3/Control.FullScreen.css">
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/MarkerCluster.css">
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/MarkerCluster.Default.css">
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
			<style type="text/css">
				#map { height : 800px; }
				.info { padding: 10px 20px; font: 20px/22px Arial, Helvetica, sans-serif; background: rgba(255,255,255,0.7);
					box-shadow: 0 0 15px rgba(0,0,0,0.4); border-radius: 7px; }
				.info h4 { margin: 0 0 5px; color: #777; }
				.popupCustom .leaflet-popup-tip,
				.popupCustom .leaflet-popup-content-wrapper {
				    background: #e0e0e0;
				    color: #234c5e;
				}
			</style>
		</head>
		<body>

			<div id="map"></div>
			<script type="text/javascript" src ="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"></script>
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.4.3/Control.FullScreen.min.js"></script>
			<script tupe="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.6/leaflet.markercluster.js"></script>
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
			<script type="text/javascript" src="js/Leaflet.CountrySelect.js"></script>
			<script type="text/javascript" src="js/Leaflet.Geodesic.js"></script>
			<script type="text/javascript" src="js/basemaps.js"></script>
			<script src="data/contacts.dat"></script>

			<script>

			  //var origin = [50.5887, 5.8699];
				var origin = L.latLng(50.5887, 5.8699);
				var map = L.map('map', {
					fullscreenControl: true,
				}).setView(origin, 4);

				L.marker(origin, {icon: L.AwesomeMarkers.icon({icon: 'home', prefix: 'fa', markerColor: 'red'}) }).addTo(map);

				var Esri_OceanBasemap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}', {
					attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
					maxZoom: 13
				});

				var OpenStreetMap_BlackAndWhite = L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
					maxZoom: 18,
					attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>. Font Awesome by Dave Gandy'
				});

				map.addLayer(OpenStreetMap_BlackAndWhite)

				var baseMaps = {
					"OpenStreetMap B&W": OpenStreetMap_BlackAndWhite,
					"Esri OceanBasemap": Esri_OceanBasemap,
					"OpenStreetMap": OpenStreetMap_Mapnik,
					"Stamen Terrain": Stamen_Terrain,
					"ESRI Dark Grey Canvas": Esri_DarkGreyCanvas,
				};

				var select = L.countrySelect({title:'Pick a country!'});


				/*
				// control that shows state info on hover
				var info = L.control({position: 'bottomright'});

				info.onAdd = function (map) {
					this._div = L.DomUtil.create('div', 'info');
					this.update();
					return this._div;
				};

				info.update = function () {
					this._div.innerHTML = ('Click on a marker to get informations');
				};
				*/

				var legend = L.control({position: 'topright'});
				legend.onAdd = function (map) {
				    var div = L.DomUtil.create('div', 'info legend');
				    div.innerHTML = `<select id="selectThematic" onchange=getThematic()>
						  <option>All disciplines</option>
							<option>Physical oceanography</option>
							<option>Chemical oceanography</option>
							<option>Modelling</option>
							<option>Remote sensing</option>
							<option>Morphology</option>
							</select>`;
				    div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
				    return div;
				};
				legend.addTo(map);

				function getThematic(){
					var e = document.getElementById("selectThematic");
					var thematic = e.options[e.selectedIndex].value;
					console.log(thematic);
					addMarkers(thematic);
				};

				//info.addTo(map);

				var GeodesicOptions = {
					weight: 2,
					opacity: .7,
					color: 'blue',
					steps: 40,
				};

				var theLine = {};
				function onClick(e) {
					if (theLine != undefined) {
              map.removeLayer(theLine);
        	};
					theLine = L.geodesic([[origin, this.getLatLng()]], GeodesicOptions).addTo(map);
				}

				function formatPopup(contact) {
					textpopup = "<a href=" + contact[3] + ">" + contact[0] + "</a><br>" + "<i class='fa fa-envelope'></i> " + contact[2];
					return textpopup;
				};

				var customOptions =
			    {
			    'maxWidth': '400',
			    'width': '200',
			    'className' : 'popupCustom',
					'opacity' : .3,
			    }

				var markers = L.markerClusterGroup();
				var ncontacts = contacts.length;

				// Initialise with all the markers
				getThematic("All disciplines");

				function addMarkers(thematic){
					// Remove the previous markers
					markers.clearLayers();
					for (var i = 0; i < ncontacts ; i++) {
						var themeList = contacts[i][4];
						if (themeList.indexOf(thematic) >= 0 || thematic === "All disciplines"){
							t = formatPopup(contacts[i]);
							m = L.marker(contacts[i][1]).bindPopup(t, customOptions).on('click', onClick);
							markers.addLayers(m);
						}
					}
					map.addLayer(markers);
			  }

				// Add country selector (not really useful)
				select.addTo(map);

				select.on('change', function(e){
					if (e.feature === undefined){ //Do nothing on title
						return;
					}
					var country = L.geoJson(e.feature);
					if (this.previousCountry != null){
						map.removeLayer(this.previousCountry);
					}
					this.previousCountry = country;

					map.addLayer(country);
					map.fitBounds(country.getBounds());

				});

				L.control.scale().addTo(map);
				L.control.layers(baseMaps, null, {autoZIndex:true, collapsed:false}).addTo(map);

			</script>

		</body>
	</html>
