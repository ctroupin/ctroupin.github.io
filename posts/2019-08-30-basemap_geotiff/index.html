<!doctype html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Charles Troupin</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Turning ocean data into stories">
    <meta name="keywords" content="data analyst, engineering, oceanography, ocean science, numerical modelling" />
    <meta name="author" content="Troupin Charles">
    <link rel="canonical" href="https://ctroupin.github.io/posts/2019-08-30-basemap_geotiff/">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

    <!-- Custom CSS & Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link rel="stylesheet" href="/style.css">

    <!-- Google verification -->
    

    <!-- Bing Verification -->
    

    <!-- Custom Fonts
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fontawesome-all.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fa-brands.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fa-regular.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/brands.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/fontawesome.min.css">
    <link rel="stylesheet" href="/assets/css/academicons.css">
    <link href="//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>


<html lang="en-US">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<title>Charles Troupin by </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=">

	<meta name="viewport" content="width=device-width">
	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

</head>

<body>

	<div class="container">
		<div class="col-lg-8 col-lg-offset-2">
			<center>
				<h2> Reading and displaying geoTIFF images with Python </h2>
			</center>
			<blogsection>
				 <div style="text-align:left; vertical-align: middle; ">
					
						<h4><i class="far fa-calendar-alt"></i></h4> 30 August 2019 &nbsp;
					
					
						<h4><i class="fas fa-wrench"></i></h4> Python, Basemap, Cartopy &nbsp;
					
					
						<h4><i class="fas fa-tags"></i></h4> Oceanography, Maps &nbsp;
					
					
				</div>
				<p>In this post we explain how to add a visible image as a background for a map.   <br />
The <code class="highlighter-rouge">geoTIFF</code> files used in this example are taken from the <a href="https://apps.sentinel-hub.com/eo-browser/">Sentinel-Hub</a> browser or from the NASA <a href="https://worldview.earthdata.nasa.gov/">WorldView</a>.   <br />
Note that you be logged in if you want to export the image in geoTIFF format from Sentinel Hub.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">Basemap</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="n">colors</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">osr</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">datafile1</span> <span class="o">=</span> <span class="s">"/data/Visible/MODIS-Terra-20160913.tiff"</span>
<span class="n">datafile2</span> <span class="o">=</span> <span class="s">"/data/Visible/Sentinel-2_L2A_2019-08-09.tiff"</span>
</code></pre></div></div>

<h2 id="1-reading-the-geotiff">1. Reading the geoTIFF</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">datafile1</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">GetProjectionRef</span><span class="p">()</span>

<span class="c"># Read the array and the transformation</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
<span class="c"># Read the geo transform</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
<span class="c"># Compute the spatial extent</span>
<span class="n">extent1</span> <span class="o">=</span> <span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="o">*</span><span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
          <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="o">*</span><span class="n">trans</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

<span class="c"># Get the info on the projection</span>
<span class="n">proj</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
<span class="n">inproj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
<span class="n">inproj</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">inproj</span><span class="p">)</span>

<span class="c"># Compute the coordinates</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">)</span>

<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">lon1</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lat1</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="c"># Transpose</span>
<span class="n">arr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>GEOGCS["WGS 84",
    DATUM["WGS_1984",
        SPHEROID["WGS 84",6378137,298.257223563,
            AUTHORITY["EPSG","7030"]],
        AUTHORITY["EPSG","6326"]],
    PRIMEM["Greenwich",0],
    UNIT["degree",0.0174532925199433],
    AUTHORITY["EPSG","4326"]]
</code></pre></div></div>

<p>Here we don’t have to modify the longitude and latitude as they are already in degrees.   <br />
Note that the array dimensions are permuted, this is because we want to use it with <code class="highlighter-rouge">imshow()</code> function.</p>

<p>We’ll explain in more details how to make nice plots.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/geotiff-plot/output_6_0.png" class="img-responsive" /></p>

<p>Let’s put all that in a function and apply it to another image from Sentinel-Hub.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="k">def</span> <span class="nf">read_geotiff</span><span class="p">(</span><span class="n">imagefile</span><span class="p">):</span>
    <span class="s">"""
    Read an image and compute the coordinates from a geoTIFF file
    """</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">imagefile</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">GetProjectionRef</span><span class="p">()</span>

    <span class="c"># Read the array and the transformation</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
    <span class="c"># Read the geo transform</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
    <span class="c"># Compute the spatial extent</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="o">*</span><span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
              <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="o">*</span><span class="n">trans</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c"># Get the info on the projection</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
    <span class="n">inproj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
    <span class="n">inproj</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

    <span class="c"># Compute the coordinates</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">)</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c"># Transpose</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">inproj</span><span class="p">,</span> <span class="n">extent</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="n">inproj2</span><span class="p">,</span> <span class="n">extent2</span> <span class="o">=</span> <span class="n">read_geotiff</span><span class="p">(</span><span class="n">datafile2</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s have a look on the projection information:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="k">print</span><span class="p">(</span><span class="n">inproj2</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>PROJCS["WGS 84 / Pseudo-Mercator",
    GEOGCS["WGS 84",
        DATUM["unknown",
            SPHEROID["unnamed",6378137,0,
                AUTHORITY["EPSG","1"]],
            AUTHORITY["EPSG","1"]],
        PRIMEM["Greenwich",0],
        UNIT["degree",0.0174532925199433],
        AUTHORITY["EPSG","4326"]],
    PROJECTION["Mercator_1SP"],
    PARAMETER["central_meridian",0],
    PARAMETER["scale_factor",1],
    PARAMETER["false_easting",0],
    PARAMETER["false_northing",0],
    UNIT["metre",1,
        AUTHORITY["EPSG","9001"]],
    EXTENSION["PROJ4","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"],
    AUTHORITY["EPSG","3857"]]
</code></pre></div></div>

<p>Without going into details, we see that we are not working with degrees and that a transformation has to be performed.    <br />
We will use the tool <a href="https://gdal.org/programs/gdalwarp.html"><code class="highlighter-rouge">gdalwarp</code></a> to do that but I’m sure it can be done in native Python.   <br />
The command to looks like:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="trac"><code>gdalwarp input.tiff output.tiff <span class="nt">-t_srs</span> <span class="s2">"+proj=longlat +ellps=WGS84"</span>
</code></pre></div></div>
<p>This creates a new geoTIFF file where the coordinates are using the <em>World Geodetic System 1984</em>.</p>

<p>Now let’s introduce that in the reading function. We will create a temporary file as the output of the command, keeping the input file unchanged, and apply the same reading steps to the temporary file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="k">def</span> <span class="nf">read_geotiff</span><span class="p">(</span><span class="n">imagefile</span><span class="p">):</span>
    <span class="s">"""
    Read an image and compute the coordinates from a geoTIFF file
    """</span>

    <span class="c"># Create temporaty file</span>
    <span class="n">fd</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>

    <span class="c"># Prepate the command (bash)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s">'gdalwarp {} {} -t_srs "+proj=longlat +ellps=WGS84"'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imagefile</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">imagefile</span><span class="p">),</span>
                   <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">GetProjectionRef</span><span class="p">()</span>

    <span class="c"># Read the array and the transformation</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>
    <span class="c"># Read the geo transform</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
    <span class="c"># Compute the spatial extent</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="o">*</span><span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
              <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="o">*</span><span class="n">trans</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c"># Get the info on the projection</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
    <span class="n">inproj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
    <span class="n">inproj</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

    <span class="c"># Compute the coordinates</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">)</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c"># Transpose</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">inproj</span><span class="p">,</span> <span class="n">extent</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="n">inproj2</span><span class="p">,</span> <span class="n">extent2</span> <span class="o">=</span> <span class="n">read_geotiff</span><span class="p">(</span><span class="n">datafile2</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>gdalwarp /data/Visible/Sentinel-2_L2A_2019-08-09.tiff /tmp/tmpsrjih4w6 -t_srs "+proj=longlat +ellps=WGS84"
</code></pre></div></div>

<p>Let’s check again the projection info:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="k">print</span><span class="p">(</span><span class="n">inproj2</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>GEOGCS["WGS 84",
    DATUM["unknown",
        SPHEROID["WGS84",6378137,298.257223563]],
    PRIMEM["Greenwich",0],
    UNIT["degree",0.0174532925199433]]
</code></pre></div></div>

<p>and we can have a quick check with <code class="highlighter-rouge">imshow()</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/geotiff-plot/output_18_0.png" class="img-responsive" /></p>

<h2 id="2-plotting-the-image">2. Plotting the image</h2>
<h3 id="21-matplotlib-only">2.1 Matplotlib only</h3>
<p>The first method is what we showed in the previous cells: using <code class="highlighter-rouge">imshow()</code>. The problem is that you cannot use the coordinates directly.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/geotiff-plot/output_20_0.png" class="img-responsive" /></p>

<h3 id="22-with-basemap">2.2 With Basemap</h3>
<p>We start by creating a Mercator projection in the region of interest.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s">'merc'</span><span class="p">,</span>
        <span class="n">llcrnrlon</span><span class="o">=</span><span class="n">lon1</span><span class="o">.</span><span class="nb">min</span><span class="p">(),</span> <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">lat1</span><span class="o">.</span><span class="nb">min</span><span class="p">(),</span>
        <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">lon1</span><span class="o">.</span><span class="nb">max</span><span class="p">(),</span> <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">lat1</span><span class="o">.</span><span class="nb">max</span><span class="p">(),</span>
        <span class="n">lat_ts</span><span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">lat1</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">lat1</span><span class="o">.</span><span class="nb">max</span><span class="p">()),</span> <span class="n">resolution</span><span class="o">=</span><span class="s">"i"</span><span class="p">)</span>
</code></pre></div></div>

<p>Now let’s plot the image and add the coastline on it to ensure they are aligned.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"w"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/geotiff-plot/output_24_1.png" class="img-responsive" /></p>

<p>Obviously we have a small issue, the visible image is upside-down, that is solved in a few seconds.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">arr1</span><span class="p">))</span>
<span class="n">m</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"w"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/geotiff-plot/output_26_1.png" class="img-responsive" /></p>

<p>the results now seems correct, at least visually.    <br />
We can add more features to the map: labels, meridians, etc.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">m</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">arr1</span><span class="p">))</span>
<span class="n">m</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"w"</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">12.</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">m</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">25.</span><span class="p">,</span> <span class="mf">35.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/geotiff-plot/output_28_1.png" class="img-responsive" /></p>

<h3 id="23-with-cartopy">2.3 With Cartopy</h3>
<p>Since <code class="highlighter-rouge">Basemap</code> is deprecated in favor of the <a href="https://scitools.org.uk/cartopy/docs/latest/"><code class="highlighter-rouge">Cartopy</code></a> project, it is relevant to show how to make this plots with <code class="highlighter-rouge">Cartopy</code>. We use this <a href="https://scitools.org.uk/cartopy/docs/v0.14/matplotlib/advanced_plotting.html#images">example</a> to guide us.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="kn">import</span> <span class="nn">cartopy</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="n">ccrs</span>
</code></pre></div></div>

<p>We start with the <em>plate carrée</em> projection:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">myproj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">myproj</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s">'upper'</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">myproj</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s">'10m'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/geotiff-plot/output_32_0.png" class="img-responsive" /></p>

<p>the results is correct, now let’s try another projection, <em>Mercator</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">myproj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Mercator</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">myproj</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s">'upper'</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s">'110m'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/geotiff-plot/output_34_0.png" class="img-responsive" /></p>

<p>Something is wrong here: the coastline does not appear.   <br />
It seems that only the <em>plate carrée</em> works for the case.</p>

			</blogsection>
		</div>
	</div>
</body>


</body>
</html>
