<!doctype html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Charles Troupin</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Turning ocean data into stories">
    <meta name="keywords" content="data analyst, engineering, oceanography, ocean science, numerical modelling" />
    <meta name="author" content="Troupin Charles">
    <link rel="canonical" href="https://ctroupin.github.io/posts/2019-09-04-cartopy-julia/">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

    <!-- Custom CSS & Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link rel="stylesheet" href="/style.css">

    <!-- Google verification -->
    

    <!-- Bing Verification -->
    

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fontawesome-all.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fa-brands.css">
    <link rel="stylesheet" href="/assets/css/font-awesome/css/fa-regular.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/css/academicons.css">
    <link href="//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>


<html lang="en-US">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<title>Charles Troupin by </title>

	<link rel="stylesheet" href="/assets/css/style.css?v=">

	<meta name="viewport" content="width=device-width">
	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

</head>

<body>

	<div class="container">
		<div class="col-lg-6 col-lg-offset-3">
			<center>
				<h2> Making plot with Cartopy and Julia </h2>
			</center>
			<blogsection>
				 <div style="text-align:left; vertical-align: middle; ">
					
						<h4><i class="far fa-calendar-alt"></i></h4> 04 September 2019 &nbsp;
					
					
						<h4><i class="fas fa-wrench"></i></h4> Julia, Cartopy, PyPlot &nbsp;
					
					
						<h4><i class="fas fa-tags"></i></h4> Oceanography, Maps &nbsp;
					
					
				</div>
				<p>A quick example of how to work with <code class="highlighter-rouge">Cartopy</code> and <code class="highlighter-rouge">Julia</code> to process and visualise 2D fields and visible images.</p>

<p><img src="https://ctroupin.github.io/figures/blog/visible_chloro_julia.png" class="img-responsive" /></p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">using</span> <span class="n">NCDatasets</span>
<span class="n">using</span> <span class="n">PyPlot</span>
<span class="n">using</span> <span class="n">ImageView</span>
<span class="n">using</span> <span class="n">ArchGDAL</span>
<span class="n">using</span> <span class="n">PyCall</span>
<span class="n">using</span> <span class="n">Conda</span>
<span class="n">Conda</span><span class="o">.</span><span class="n">add</span><span class="x">(</span><span class="s">"cmocean"</span><span class="x">)</span>
</code></pre></div></div>

<h2 id="data">Data</h2>

<p>We will use:</p>
<ol>
  <li>Sentinel-2 image (geoTIFF format) downloaded from the <a href="https://apps.sentinel-hub.com/eo-browser/?lat=57.991&amp;lng=18.620&amp;zoom=9&amp;time=2019-08-09&amp;preset=1_TRUE_COLOR&amp;atmFilter=DOS1&amp;datasource=Sentinel-2%20L2A">Sentinel-Hub</a> browser and</li>
  <li>A netCDF file containg measurements of chlorophyll concentration, also Sentinel-2.</li>
</ol>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">imagefile</span> <span class="o">=</span> <span class="s">"/data/Visible/Sentinel-2_L2A_2019-08-09c.tiff"</span>
<span class="n">datafile</span> <span class="o">=</span> <span class="s">"/data/Sentinel2/S2A_MSI_2019_08_09_10_00_31_T34VCK_L2W.nc"</span>
<span class="n">isfile</span><span class="x">(</span><span class="n">imagefile</span><span class="x">)</span> <span class="o">&amp;</span> <span class="n">isfile</span><span class="x">(</span><span class="n">datafile</span><span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>true
</code></pre></div></div>

<h3 id="reading-the-netcdf-file">Reading the netCDF file</h3>
<p>That’s an easy job if we use the <code class="highlighter-rouge">NCDatasets</code> module.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="k">function</span><span class="nf"> read_chloro</span><span class="x">(</span><span class="n">datafile</span><span class="o">::</span><span class="kt">String</span><span class="x">)</span>
    <span class="kd">local</span> <span class="n">lon</span><span class="x">,</span> <span class="n">lat</span><span class="x">,</span> <span class="n">chl_oc3</span>
    <span class="n">NCDatasets</span><span class="o">.</span><span class="n">Dataset</span><span class="x">(</span><span class="n">datafile</span><span class="x">,</span> <span class="s">"r"</span><span class="x">)</span> <span class="n">do</span> <span class="n">ds</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">ds</span><span class="x">[</span><span class="s">"lon"</span><span class="x">][:]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">ds</span><span class="x">[</span><span class="s">"lat"</span><span class="x">][:]</span>
        <span class="n">chl_oc3</span> <span class="o">=</span> <span class="n">ds</span><span class="x">[</span><span class="s">"chl_oc3"</span><span class="x">][:]</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">lon</span><span class="x">,</span> <span class="n">lat</span><span class="x">,</span> <span class="n">chl_oc3</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>read_chloro (generic function with 1 method)
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">lon</span><span class="x">,</span> <span class="n">lat</span><span class="x">,</span> <span class="n">chl_oc3</span> <span class="o">=</span> <span class="n">read_chloro</span><span class="x">(</span><span class="n">datafile</span><span class="x">);</span>
</code></pre></div></div>

<p>Let’s make a quick plot:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">NN</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">PyPlot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="x">(</span><span class="n">lon</span><span class="x">[</span><span class="mi">1</span><span class="x">:</span><span class="n">NN</span><span class="x">:</span><span class="k">end</span><span class="x">,</span><span class="mi">1</span><span class="x">:</span><span class="n">NN</span><span class="x">:</span><span class="k">end</span><span class="x">],</span> <span class="n">lat</span><span class="x">[</span><span class="mi">1</span><span class="x">:</span><span class="n">NN</span><span class="x">:</span><span class="k">end</span><span class="x">,</span><span class="mi">1</span><span class="x">:</span><span class="n">NN</span><span class="x">:</span><span class="k">end</span><span class="x">],</span>
    <span class="n">chl_oc3</span><span class="x">[</span><span class="mi">1</span><span class="x">:</span><span class="n">NN</span><span class="x">:</span><span class="k">end</span><span class="x">,</span><span class="mi">1</span><span class="x">:</span><span class="n">NN</span><span class="x">:</span><span class="k">end</span><span class="x">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">PyPlot</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">BuGn_r</span><span class="x">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mf">0.95</span><span class="x">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">7.5</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/cartopy-julia/output_8_0.png" class="img-responsive" /></p>

<h3 id="reading-the-geotiff">Reading the geoTIFF</h3>
<p>We will use the <a href="https://github.com/yeesian/ArchGDAL.jl"><code class="highlighter-rouge">ArchGDAL</code></a> package to access the information from the geoTIFF file.     <br />
The function below reads the dimensions, the coordinates and the 2D layer.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="k">function</span><span class="nf"> read_geotiff</span><span class="x">(</span><span class="n">filename</span><span class="o">::</span><span class="kt">String</span><span class="x">)</span>
    <span class="kd">local</span> <span class="n">field</span><span class="x">,</span> <span class="n">lon</span><span class="x">,</span> <span class="n">lat</span><span class="x">,</span> <span class="n">proj4</span><span class="x">,</span> <span class="n">extent</span>
    <span class="n">ArchGDAL</span><span class="o">.</span><span class="n">registerdrivers</span><span class="x">()</span> <span class="n">do</span>
        <span class="n">ArchGDAL</span><span class="o">.</span><span class="n">read</span><span class="x">(</span><span class="n">filename</span><span class="x">)</span> <span class="n">do</span> <span class="n">dataset</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">ArchGDAL</span><span class="o">.</span><span class="n">width</span><span class="x">(</span><span class="n">dataset</span><span class="x">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">ArchGDAL</span><span class="o">.</span><span class="n">height</span><span class="x">(</span><span class="n">dataset</span><span class="x">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">ArchGDAL</span><span class="o">.</span><span class="n">read</span><span class="x">(</span><span class="n">dataset</span><span class="x">)</span>
            <span class="n">gt</span> <span class="o">=</span> <span class="n">ArchGDAL</span><span class="o">.</span><span class="n">getgeotransform</span><span class="x">(</span><span class="n">dataset</span><span class="x">)</span>
            <span class="n">dx</span><span class="x">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">gt</span><span class="x">[</span><span class="mi">2</span><span class="x">],</span> <span class="o">-</span><span class="n">gt</span><span class="x">[</span><span class="k">end</span><span class="x">]</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">gt</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">+</span> <span class="n">dx</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="x">(</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="x">)</span> <span class="o">*</span> <span class="n">dx</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">gt</span><span class="x">[</span><span class="mi">4</span><span class="x">]</span> <span class="o">-</span> <span class="n">dy</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="x">(</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="x">)</span><span class="o">*</span><span class="n">dy</span>

            <span class="n">proj4</span> <span class="o">=</span> <span class="n">strip</span><span class="x">(</span><span class="n">ArchGDAL</span><span class="o">.</span><span class="n">toPROJ4</span><span class="x">(</span><span class="n">ArchGDAL</span><span class="o">.</span><span class="n">importWKT</span><span class="x">(</span><span class="n">ArchGDAL</span><span class="o">.</span><span class="n">getproj</span><span class="x">(</span><span class="n">dataset</span><span class="x">))))</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">x0</span><span class="x">:</span><span class="n">dx</span><span class="x">:</span><span class="n">x1</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">y0</span><span class="x">:</span><span class="n">dy</span><span class="x">:</span><span class="n">y1</span>

            <span class="n">extent</span> <span class="o">=</span> <span class="x">(</span><span class="n">x0</span><span class="x">,</span> <span class="n">x1</span><span class="x">,</span> <span class="n">y0</span><span class="x">,</span> <span class="n">y1</span><span class="x">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">lon</span><span class="x">,</span> <span class="n">lat</span><span class="x">,</span> <span class="n">field</span><span class="x">,</span> <span class="n">proj4</span><span class="x">,</span> <span class="n">extent</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>read_geotiff (generic function with 1 method)
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">lonvis</span><span class="x">,</span> <span class="n">latvis</span><span class="x">,</span> <span class="n">imagevis</span><span class="x">,</span> <span class="n">proj4</span><span class="x">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">read_geotiff</span><span class="x">(</span><span class="n">imagefile</span><span class="x">);</span>
<span class="nd">@info</span><span class="x">(</span><span class="s">"Image size: </span><span class="si">$</span><span class="s">(size(imagevis))"</span><span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>┌ Info: Image size: (3564, 1833, 3)
└ @ Main In[4]:2
</code></pre></div></div>

<p>For the plot we can simply use the <code class="highlighter-rouge">imshow()</code> method.   <br />
Note the permutation applied to the first 2 dimensions of the field.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">PyPlot</span><span class="o">.</span><span class="n">imshow</span><span class="x">(</span><span class="n">permutedims</span><span class="x">(</span><span class="n">imagevis</span><span class="x">,</span> <span class="x">(</span><span class="mi">2</span><span class="x">,</span><span class="mi">1</span><span class="x">,</span><span class="mi">3</span><span class="x">)))</span>
</code></pre></div></div>

<p><img src="https://ctroupin.github.io/figures/blog/cartopy-julia/output_13_0.png" class="img-responsive" /></p>

<h2 id="plotting-with-cartopy">Plotting with Cartopy</h2>

<p>The installation of Cartopy with Julia is not explained in details here. A solution is to use the <code class="highlighter-rouge">Conda</code> module and then install <code class="highlighter-rouge">Cartopy</code> with:</p>
<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">using</span> <span class="n">Conda</span>
<span class="n">Conda</span><span class="o">.</span><span class="n">add</span><span class="x">(</span><span class="s">"Cartopy"</span><span class="x">)</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">Cartopy</code> is a Python module hence it is not directly imported by Julia.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">ccrs</span> <span class="o">=</span> <span class="n">pyimport</span><span class="x">(</span><span class="s">"cartopy.crs"</span><span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="trac"><code>PyObject &lt;module 'cartopy.crs' from '/home/ctroupin/.julia/conda/3/lib/python3.7/site-packages/cartopy/crs.py'&gt;
</code></pre></div></div>

<h3 id="create-a-projection">Create a projection</h3>
<p>We will use a <em>Plate-Carrée</em> projection.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">myproj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="x">();</span>
</code></pre></div></div>

<h3 id="make-the-plot">Make the plot</h3>
<p>Just combining the different elements and limiting the domain to the chlorophyll field:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="trac"><code><span class="n">PyPlot</span><span class="o">.</span><span class="n">figure</span><span class="x">(</span><span class="n">figsize</span><span class="o">=</span><span class="x">(</span><span class="mi">8</span><span class="x">,</span> <span class="mi">8</span><span class="x">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">PyPlot</span><span class="o">.</span><span class="n">subplot</span><span class="x">(</span><span class="mi">111</span><span class="x">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">myproj</span><span class="x">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="x">(</span><span class="n">lon</span><span class="x">,</span> <span class="n">lat</span><span class="x">,</span> <span class="n">chl_oc3</span><span class="x">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">PyPlot</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">BuGn_r</span><span class="x">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mf">0.95</span><span class="x">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">7.5</span><span class="x">)</span>
<span class="n">PyPlot</span><span class="o">.</span><span class="n">imshow</span><span class="x">(</span><span class="n">permutedims</span><span class="x">(</span><span class="n">imagevis</span><span class="x">,</span> <span class="x">(</span><span class="mi">2</span><span class="x">,</span><span class="mi">1</span><span class="x">,</span><span class="mi">3</span><span class="x">)),</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="x">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="x">(</span><span class="n">minimum</span><span class="x">(</span><span class="n">lon</span><span class="x">),</span> <span class="n">maximum</span><span class="x">(</span><span class="n">lon</span><span class="x">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="x">(</span><span class="n">minimum</span><span class="x">(</span><span class="n">lat</span><span class="x">),</span> <span class="n">maximum</span><span class="x">(</span><span class="n">lat</span><span class="x">))</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="x">(</span><span class="n">crs</span><span class="o">=</span><span class="n">myproj</span><span class="x">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">5</span><span class="x">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"white"</span><span class="x">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="x">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">"--"</span><span class="x">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">6</span><span class="x">)</span>
<span class="n">PyPlot</span><span class="o">.</span><span class="n">savefig</span><span class="x">(</span><span class="s">"./visible_chloro_julia.png"</span><span class="x">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="x">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">"tight"</span><span class="x">)</span>
</code></pre></div></div>

<h4 id="final-remarks">Final remarks</h4>
<ol>
  <li>I’m quite new to <code class="highlighter-rouge">Cartopy</code> so there are probably many ways to improve the figure.</li>
  <li>For the final plot you may want to use the full resolution for the 2D field (i.e. setting NN=1). Just take into account that this may take a while, more than 20 minutes in my case, with the computer almost not responding.</li>
  <li>The <code class="highlighter-rouge">PyPlot.</code>prefixes of the commands can certainly be removed, but I prefer to keep them for explicitness.</li>
</ol>

			</blogsection>
		</div>
	</div>
</body>


</body>
</html>
